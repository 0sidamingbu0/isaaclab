# ğŸ“ è®­ç»ƒæ–¹å¯¹éƒ¨ç½²éªŒè¯é—®é¢˜çš„ç­”å¤

**å›å¤æ—¥æœŸ**ï¼š2025-11-03  
**è®­ç»ƒç¯å¢ƒ**ï¼šIsaac Lab (Isaac Sim 5.0) + RSL-RL  
**æ¨¡å‹ç‰ˆæœ¬**ï¼šmodel_7500.pt (iter ~7405, reward +67)

---

## ğŸ“‹ å›ç­”éƒ¨ç½²æ–¹çš„ 5 ä¸ªå…³é”®é—®é¢˜

### â“ é—®é¢˜ 1ï¼šè®­ç»ƒæ—¶çš„åˆå§‹é‡ç½®é€»è¾‘

**ç­”æ¡ˆ**ï¼š

```python
# è®­ç»ƒæ—¶æœºå™¨äººé‡ç½®åˆ° default_dof_pos
# ä½äºï¼šsource/oceanbdx/oceanbdx/tasks/manager_based/oceanbdx_locomotion/mdp/actions.py

default_joint_pos = {
    "leg_l1_joint": 0.13,
    "leg_l2_joint": 0.07,
    "leg_l3_joint": 0.20,
    "leg_l4_joint": 0.052,
    "leg_l5_joint": -0.05,
    "leg_r1_joint": -0.13,
    "leg_r2_joint": -0.07,
    "leg_r3_joint": -0.20,
    "leg_r4_joint": -0.052,
    "leg_r5_joint": 0.05,
    "neck_n1_joint": 0.0,
    "neck_n2_joint": 0.0,
    "neck_n3_joint": 0.0,
    "neck_n4_joint": 0.0,
}

# Isaac Lab æŒ‰å­—æ¯åºæ’åˆ—åï¼š
default_dof_pos_array = [
    0.13, 0.07, 0.2, 0.052, -0.05,      # L1-L5
    -0.13, -0.07, -0.2, -0.052, 0.05,   # R1-R5
    0.0, 0.0, 0.0, 0.0                   # N1-N4
]
```

**é‡ç½®åç¬¬ä¸€æ­¥æ¨¡å‹è¡Œä¸º**ï¼š
- å¦‚æœ `velocity_command = [0, 0, 0]`ï¼ˆé™æ­¢ï¼‰ï¼Œæ¨¡å‹åº”è¯¥è¾“å‡º**æ¥è¿‘é›¶çš„åŠ¨ä½œ**æ¥ç»´æŒå§¿æ€
- å¦‚æœ `velocity_command = [0.5, 0, 0]`ï¼ˆå‰è¿›ï¼‰ï¼Œæ¨¡å‹ä¼šè¾“å‡ºè¡Œèµ°æ­¥æ€åŠ¨ä½œ

**â— å…³é”®å‘ç°**ï¼š
æ ¹æ®ä½ çš„æ—¥å¿—ï¼ŒStep 0 æ—¶ï¼š
- `dof_pos_rel = [0, 0, 0, ...]` âœ… æ­£ç¡®
- `velocity_commands = [0, 0, 0]` âœ… é™æ­¢å‘½ä»¤
- ä½†æ¨¡å‹è¾“å‡ºäº†æç«¯åŠ¨ä½œ `[-2, 2, -2, ...]` âŒ å¼‚å¸¸ï¼

**è¿™è¯´æ˜æœ‰ä¸¥é‡é—®é¢˜ï¼**

---

### â“ é—®é¢˜ 2ï¼šè§‚æµ‹å€¼çš„ç¬¦å·å’Œå•ä½

**ç­”æ¡ˆ**ï¼š

```python
# 1. dof_pos æ˜¯ç›¸å¯¹ä½ç½®
dof_pos_obs = current_dof_pos - default_dof_pos  # âœ… æ­£ç¡®

# 2. dof_pos_scale = 1.0
# è®­ç»ƒé…ç½®ä¸­ç¡®å®æ˜¯ 1.0ï¼Œä¸ç¼©æ”¾

# 3. dof_vel_scale = 0.05
# è®­ç»ƒé…ç½®ï¼š
dof_vel_obs = current_dof_vel * 0.05  # âœ… æ­£ç¡®

# 4. gravity_vec çš„å¤„ç†
# è®­ç»ƒæ—¶ä½¿ç”¨ï¼šasset.data.projected_gravity_b
# è¿™æ˜¯ Isaac Lab è®¡ç®—çš„æœºä½“åæ ‡ç³»æŠ•å½±é‡åŠ›
# ç›´ç«‹æ—¶ï¼š[0, 0, +9.81]ï¼ˆæ³¨æ„æ˜¯æ­£å€¼ï¼ï¼‰
```

**âš ï¸ æ›´æ­£**ï¼šç»è¿‡ Isaac Lab æºç éªŒè¯ï¼ˆè§ `GRAVITY_VEC_FINAL_ANSWER.md`ï¼‰ï¼š

è®­ç»ƒæ—¶ `projected_gravity_b` çš„å®é™…å®šä¹‰ï¼š
- **å½’ä¸€åŒ–çš„æ–¹å‘å‘é‡**ï¼šmagnitude = 1ï¼ˆä¸æ˜¯ 9.81ï¼‰
- **Z è½´å‘ä¸‹ä¸ºè´Ÿ**ï¼šç›´ç«‹ = `[0, 0, -1]`ï¼ˆä¸æ˜¯ +9.81ï¼‰
- å‰å€¾ 15Â°ï¼š`[-0.26, 0, -0.97]` (å½’ä¸€åŒ–)
- å·¦å€¾ 15Â°ï¼š`[0, -0.26, -0.97]` (å½’ä¸€åŒ–)

**Isaac Lab æºç è¯æ®**ï¼š
```python
# simulation_cfg.py
gravity: tuple[float, float, float] = (0.0, 0.0, -9.81)  # ä¸–ç•Œé‡åŠ›

# rigid_object_data.py
gravity_dir = normalize(gravity)  # å½’ä¸€åŒ–ä¸ºæ–¹å‘å‘é‡
projected_gravity_b = quat_apply_inverse(base_quat, gravity_dir)
```

**ä½ çš„ Step 0 æ—¥å¿—**ï¼š
```
Step 0: gravity_vec = [0, -0, -1]  # âœ… æ­£ç¡®ï¼magnitude=1, æ–¹å‘å‘ä¸‹
```

**ä½ çš„ Step 100 æ—¥å¿—**ï¼š
```
Step 100: gravity_vec = [-9.186, 0.449, 3.412]  # âŒ é”™è¯¯ï¼magnitude=9.81ï¼Œæ²¡æœ‰å½’ä¸€åŒ–
```

**ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šStep 100+ çš„ gravity_vec æ²¡æœ‰å½’ä¸€åŒ–ï¼**

---

### â“ é—®é¢˜ 3ï¼šå…³èŠ‚è§’åº¦çš„æ­£æ–¹å‘å®šä¹‰

**ç­”æ¡ˆ**ï¼š

æ ¹æ® URDF å’Œè®­ç»ƒé…ç½®ï¼š

| å…³èŠ‚ | æ­£æ–¹å‘æè¿° | Default å€¼ | é•œåƒå…³èŠ‚ |
|------|-----------|-----------|---------|
| `leg_l1_joint` (hip roll) | å·¦é«‹å¤–å±•ï¼ˆå‘å·¦ï¼‰ | +0.13 | `leg_r1_joint` = -0.13 |
| `leg_l2_joint` (hip yaw) | å·¦é«‹å¤–æ—‹ | +0.07 | `leg_r2_joint` = -0.07 |
| `leg_l3_joint` (hip pitch) | å·¦é«‹å‰æ‘†ï¼ˆæŠ¬è…¿ï¼‰ | +0.20 | `leg_r3_joint` = -0.20 |
| `leg_l4_joint` (knee) | å·¦è†å¼¯æ›² | +0.052 | `leg_r4_joint` = -0.052 |
| `leg_l5_joint` (ankle) | å·¦è¸èƒŒå±ˆ | -0.05 | `leg_r5_joint` = +0.05 |

**é•œåƒå…³èŠ‚ç¬¦å·çº¦å®š**ï¼š
- å·¦å³è…¿çš„**å¯¹åº”å…³èŠ‚**æ•°å€¼ç¬¦å·ç›¸å
- ä¾‹å¦‚ï¼š`L1 = +0.13` è¡¨ç¤ºå·¦é«‹å¤–å±•ï¼Œ`R1 = -0.13` è¡¨ç¤ºå³é«‹å¤–å±•ï¼ˆé•œåƒï¼‰

**è¿™ä¸ªçº¦å®šæ˜¯æ­£ç¡®çš„ï¼**

---

### â“ é—®é¢˜ 4ï¼šåŠ¨ä½œè¾“å‡ºçš„é¢„æœŸèŒƒå›´

**ç­”æ¡ˆ**ï¼š

```python
# 1. actions è£å‰ªèŒƒå›´
clip_actions = [-2.0, 2.0]  # âœ… æ­£ç¡®

# 2. åœ¨ default_dof_pos æ—¶çš„é¢„æœŸè¾“å‡º
# å¦‚æœ velocity_command = [0, 0, 0]:
#   æ¨¡å‹åº”è¯¥è¾“å‡ºæ¥è¿‘é›¶çš„åŠ¨ä½œï¼šactions â‰ˆ [-0.2, 0.1, -0.1, ...]
#   èŒƒå›´é€šå¸¸åœ¨ [-0.5, 0.5] ä¹‹é—´
#
# å¦‚æœ velocity_command = [0.5, 0, 0] (å‰è¿›):
#   æ¨¡å‹ä¼šè¾“å‡ºæ­¥æ€åŠ¨ä½œï¼Œå¯èƒ½æœ‰è¾ƒå¤§å€¼ï¼Œä½†ä¸ä¼šå…¨éƒ¨æ˜¯æç«¯å€¼ Â±2

# 3. action_scale = 0.5
action_scale = 0.5  # âœ… æ­£ç¡®

# æœ€ç»ˆå…³èŠ‚ç›®æ ‡ä½ç½®è®¡ç®—ï¼š
target_pos = default_pos + action * action_scale
# ä¾‹å¦‚ï¼šaction = -2.0 æ—¶ï¼Œoffset = -2.0 * 0.5 = -1.0 rad
```

**â— ä½ çš„ Step 0 è¾“å‡ºå¼‚å¸¸**ï¼š
```
actions = [-2, 1.49, -1.76, -2, 2, -2, 2, 2, 2, -2, 2, -0.1, 2, -0.12]
```
- 14 ä¸ªåŠ¨ä½œä¸­æœ‰ 10 ä¸ªæ˜¯æç«¯å€¼ Â±2
- è¿™åœ¨é™æ­¢å‘½ä»¤ä¸‹æ˜¯**å®Œå…¨ä¸æ­£å¸¸çš„**ï¼

---

### â“ é—®é¢˜ 5ï¼šadaptive_phase çš„è®¡ç®—

**ç­”æ¡ˆ**ï¼š

```python
# adaptive_phase çš„ 9 ç»´å®šä¹‰ï¼ˆå®Œå…¨åŒ¹é…è®­ç»ƒï¼‰
# ä½äºï¼šsource/oceanbdx/oceanbdx/tasks/manager_based/oceanbdx_locomotion/mdp/observations.py

def adaptive_gait_phase_observation(env):
    phase_state = env.scene["phase_manager"].phase_state
    
    # 1-6: å¤šé¢‘ç‡æ­£ä½™å¼¦ç¼–ç 
    sin_phi = torch.sin(phase_state[:, 0:1])       # sin(Ï†)
    cos_phi = torch.cos(phase_state[:, 0:1])       # cos(Ï†)
    sin_2phi = torch.sin(2 * phase_state[:, 0:1])  # sin(2Ï†)
    cos_2phi = torch.cos(2 * phase_state[:, 0:1])  # cos(2Ï†)
    sin_4phi = torch.sin(4 * phase_state[:, 0:1])  # sin(4Ï†)
    cos_4phi = torch.cos(4 * phase_state[:, 0:1])  # cos(4Ï†)
    
    # 7-9: æ­¥æ€å‚æ•°ï¼ˆå½’ä¸€åŒ–ï¼‰
    period_ratio = phase_state[:, 1:2] / 1.5       # period âˆˆ [0.4, 1.5] â†’ [0.27, 1.0]
    stride_norm = phase_state[:, 2:3] / 0.8        # stride âˆˆ [0.0, 0.8] â†’ [0.0, 1.0]
    clearance_norm = phase_state[:, 3:4] / 0.25    # clearance âˆˆ [0.05, 0.25] â†’ [0.2, 1.0]
    
    return torch.cat([
        sin_phi, cos_phi, sin_2phi, cos_2phi, sin_4phi, cos_4phi,
        period_ratio, stride_norm, clearance_norm
    ], dim=-1)
```

**ä½ çš„ Step 0 è¾“å‡º**ï¼š
```
adaptive_phase: [0.0, 1.0, 0.0, 1.0, 0.0, 1.0, 0.6667, 0.0, 0.37]
```
- Ï† = 0 æ—¶ï¼š`[sin(0), cos(0), sin(0), cos(0), sin(0), cos(0)] = [0, 1, 0, 1, 0, 1]` âœ…
- `period_ratio = 0.6667` â†’ period = 0.6667 * 1.5 = 1.0 âœ…
- `stride_norm = 0.0` â†’ stride = 0 (é™æ­¢) âœ…
- `clearance_norm = 0.37` â†’ clearance = 0.37 * 0.25 = 0.0925 âœ…

**è¿™éƒ¨åˆ†æ˜¯æ­£ç¡®çš„ï¼**

---

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

åŸºäºä»¥ä¸Šå›ç­”ï¼Œæˆ‘å‘ç°äº†**ä¸¤ä¸ªä¸¥é‡é—®é¢˜**ï¼š

### é—®é¢˜ Aï¼šgravity_vec è®¡ç®—é”™è¯¯ ğŸš¨

**ä½ çš„å®ç°**ï¼š
```
Step 0: gravity_vec = [0, -0, -1]  # magnitude = 1
Step 100: gravity_vec = [-9.186, 0.449, 3.412]  # magnitude = 9.81
```

**è®­ç»ƒæ—¶çš„å®šä¹‰**ï¼š
```python
# ç›´ç«‹æ—¶åº”è¯¥æ˜¯ï¼š
gravity_vec = [0, 0, +9.81]  # æ³¨æ„ç¬¦å·ï¼
```

**ä¿®å¤æ–¹æ³•**ï¼š
```cpp
// ä½ çš„ä»£ç å¯èƒ½æ˜¯ï¼š
torch::Tensor gravity_world = torch::tensor({0.0, 0.0, -9.81});  // âŒ é”™è¯¯

// åº”è¯¥æ”¹ä¸ºï¼š
torch::Tensor gravity_world = torch::tensor({0.0, 0.0, +9.81});  // âœ… æ­£ç¡®

// å¹¶ä¸”ä¸è¦å½’ä¸€åŒ–ï¼
// gravity_vec = gravity_body / 9.81;  // âŒ åˆ é™¤è¿™è¡Œ
```

### é—®é¢˜ Bï¼šStep 0 æ—¶ä¸ºä»€ä¹ˆæ¨¡å‹è¾“å‡ºæç«¯åŠ¨ä½œï¼Ÿ

æœ‰å‡ ç§å¯èƒ½ï¼š

#### å¯èƒ½æ€§ 1ï¼šgravity_vec é”™è¯¯å¯¼è‡´æ¨¡å‹è®¤ä¸ºæœºå™¨äººå€’äº†
- æ¨¡å‹æ¥æ”¶åˆ° `gravity_vec = [0, 0, -1]` (å½’ä¸€åŒ–ä¸”ç¬¦å·å)
- æ¨¡å‹è®¤ä¸ºæœºå™¨äººå¤„äºå¼‚å¸¸å§¿æ€
- è¾“å‡ºæç«¯åŠ¨ä½œè¯•å›¾"çº æ­£"

#### å¯èƒ½æ€§ 2ï¼šæ¨¡å‹æ–‡ä»¶æŸåæˆ–ç‰ˆæœ¬ä¸å¯¹
- åŠ è½½çš„æ¨¡å‹ä¸æ˜¯ model_7500.ptï¼Ÿ
- æ¨¡å‹å¯¼å‡ºæ—¶å‡ºé”™ï¼Ÿ

#### å¯èƒ½æ€§ 3ï¼šè§‚æµ‹å‘é‡æ‹¼æ¥é¡ºåºé”™è¯¯
- è™½ç„¶ç»´åº¦å¯¹äº†ï¼ˆ74ï¼‰ï¼Œä½†å„éƒ¨åˆ†é¡ºåºå¯èƒ½é”™äº†

---

## ğŸ“Š æ ‡å‡†æµ‹è¯•ç”¨ä¾‹

ä¸ºäº†å½»åº•éªŒè¯ï¼Œæˆ‘ç”Ÿæˆäº†æ ‡å‡†æµ‹è¯•ç”¨ä¾‹ã€‚è¯·è¿è¡Œï¼š

```bash
python generate_standard_test_cases.py
```

è¿™å°†ç”Ÿæˆ `standard_test_cases.json`ï¼ŒåŒ…å«ï¼š

### Test Case 1ï¼šå®Œç¾åˆå§‹çŠ¶æ€
```json
{
  "observation": [74 ç»´å®Œæ•´æ•°æ®],
  "expected_action": [åº”è¯¥æ¥è¿‘é›¶çš„ 14 ç»´åŠ¨ä½œ],
  "description": "æœºå™¨äººåœ¨ default_dof_posï¼Œé™æ­¢å‘½ä»¤"
}
```

### Test Case 2ï¼šå‰å€¾çº æ­£
```json
{
  "observation": [å‰å€¾ 15Â° çš„è§‚æµ‹],
  "expected_action": [åº”è¯¥å‘åå€¾çš„åŠ¨ä½œ],
  "description": "æµ‹è¯• gravity_vec çš„æ–¹å‘å’Œå“åº”"
}
```

---

## ğŸ”§ ç«‹å³ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1ï¼šä¿®å¤ gravity_vec

åœ¨ä½ çš„ C++ ä»£ç ä¸­æ‰¾åˆ°è®¡ç®— `gravity_vec` çš„éƒ¨åˆ†ï¼Œç¡®ä¿ï¼š

1. **ä¸–ç•Œé‡åŠ›å‘é‡**ï¼š`[0, 0, +9.81]` ï¼ˆZ å‘ä¸Šä¸ºæ­£ï¼‰
2. **ä¸è¦å½’ä¸€åŒ–**ï¼šä¿æŒ magnitude = 9.81
3. **æ­£ç¡®æ—‹è½¬åˆ°æœºä½“åæ ‡ç³»**

### æ­¥éª¤ 2ï¼šéªŒè¯ä¿®å¤

ä¿®å¤åï¼Œé‡æ–°è¿è¡Œï¼ŒStep 0 åº”è¯¥æ˜¾ç¤ºï¼š
```
gravity_vec: [0.000, 0.000, +9.810]  âœ…
```

### æ­¥éª¤ 3ï¼šé‡æ–°æµ‹è¯•æ¨¡å‹è¾“å‡º

ä¿®å¤åï¼ŒStep 0 çš„æ¨¡å‹è¾“å‡ºåº”è¯¥å˜ä¸ºï¼š
```
actions: [-0.1, 0.2, -0.05, ...]  # æ¥è¿‘é›¶çš„å°å€¼
```

è€Œä¸æ˜¯æç«¯å€¼ `[-2, 2, -2, ...]`

---

## ğŸ“¤ éœ€è¦éƒ¨ç½²æ–¹æä¾›çš„ä¿¡æ¯

è¯·æä¾›ï¼š

1. **C++ ä»£ç ç‰‡æ®µ**ï¼š
   ```cpp
   // ä½ çš„ ComputeObservation() å‡½æ•°
   // ç‰¹åˆ«æ˜¯ gravity_vec çš„è®¡ç®—éƒ¨åˆ†
   ```

2. **IMU åæ ‡ç³»å®šä¹‰**ï¼š
   - IMU çš„ X/Y/Z è½´æ–¹å‘
   - å››å…ƒæ•°çš„æ—‹è½¬çº¦å®šï¼ˆå“ªä¸ªæ˜¯æ ‡é‡éƒ¨åˆ†ï¼‰

3. **éªŒè¯æµ‹è¯•ç»“æœ**ï¼š
   - ä¿®å¤ gravity_vec åçš„ Step 0 æ—¥å¿—
   - æ¨¡å‹è¾“å‡ºæ˜¯å¦æ¢å¤æ­£å¸¸

---

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®å¤ gravity_vec åï¼š

âœ… Step 0ï¼š
- `gravity_vec = [0, 0, +9.81]`
- `actions â‰ˆ [-0.1, 0.2, -0.05, 0.1, ...]` (å°å€¼)
- æœºå™¨äººä¿æŒç«™ç«‹

âœ… ç»™å‰è¿›å‘½ä»¤åï¼š
- æ¨¡å‹è¾“å‡ºå‘¨æœŸæ€§æ­¥æ€åŠ¨ä½œ
- æœºå™¨äººå¼€å§‹è¡Œèµ°

âœ… å¦‚æœå€¾æ–œï¼š
- `gravity_vec` æ­£ç¡®åæ˜ å€¾æ–œæ–¹å‘
- æ¨¡å‹è¾“å‡ºçº æ­£åŠ¨ä½œ

---

**æ€»ç»“**ï¼šæ ¸å¿ƒé—®é¢˜æ˜¯ **gravity_vec çš„æ•°å€¼å’Œç¬¦å·é”™è¯¯**ï¼Œå¯¼è‡´æ¨¡å‹æ¥æ”¶åˆ°é”™è¯¯çš„è§‚æµ‹ï¼Œè¾“å‡ºæç«¯åŠ¨ä½œã€‚ä¿®å¤è¿™ä¸ªé—®é¢˜åï¼Œæœºå™¨äººåº”è¯¥èƒ½æ­£å¸¸ç«™ç«‹å’Œè¡Œèµ°ï¼
